<!-- build time:Wed Jan 08 2020 16:16:34 GMT+0800 (中国标准时间) --><!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="description" content="缓存问题及优化方案总结"><meta name="keywords" content><meta name="author" content="zhangj"><meta name="copyright" content="zhangj"><title>缓存问题及优化方案总结 | 回归初心，轻装前行</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"search.xml",languages:{hits_empty:"We didn't find any results for the search: ${query}"}},copy:{success:"Copy successfully",error:"Copy error",noSupport:"The browser does not support"}}</script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#缓存优化"><span class="toc-number">1.</span> <span class="toc-text">缓存优化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-缓存穿透"><span class="toc-number">1.1.</span> <span class="toc-text">1. 缓存穿透</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-1-穿透优化方案"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.1 穿透优化方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-2-对比"><span class="toc-number">1.1.2.</span> <span class="toc-text">1.2 对比</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-无底洞"><span class="toc-number">1.2.</span> <span class="toc-text">2. 无底洞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#2-1-无底洞优化思路"><span class="toc-number">1.2.1.</span> <span class="toc-text">2.1 无底洞优化思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-2-方案"><span class="toc-number">1.2.2.</span> <span class="toc-text">2.2 方案</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-缓存雪崩"><span class="toc-number">1.3.</span> <span class="toc-text">3. 缓存雪崩</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#3-1-优化思路（预防和解决）"><span class="toc-number">1.3.1.</span> <span class="toc-text">3.1 优化思路（预防和解决）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-热点key重建"><span class="toc-number">1.4.</span> <span class="toc-text">4.热点key重建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-优化思路"><span class="toc-number">1.4.1.</span> <span class="toc-text">4.1 优化思路</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-优化方案"><span class="toc-number">1.4.2.</span> <span class="toc-text">4.2 优化方案</span></a></li></ol></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">zhangj</div><div class="author-info__description text-center"></div><div class="follow-button"><a href="https://github.com/zjcool">follw me</a></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">21</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">12</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">9</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="http://www.zhangkangnjgy.cn">康康的博客</a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"><a id="site-name" href="/">回归初心，轻装前行</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">缓存问题及优化方案总结</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-10-22</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/缓存/">缓存</a><div class="post-meta-wordcount"><span>Word count: </span><span class="word-count">714</span><span class="post-meta__separator">|</span><span>Reading time: 2 min</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="缓存优化"><a href="#缓存优化" class="headerlink" title="缓存优化"></a>缓存优化</h2><h3 id="1-缓存穿透"><a href="#1-缓存穿透" class="headerlink" title="1. 缓存穿透"></a>1. 缓存穿透</h3><p>现象解释：大量出现查询一个根本不存在的数据，缓存层和存储层都不会命中。从而导致后端负载加大，甚至服务宕机。</p><h4 id="1-1-穿透优化方案"><a href="#1-1-穿透优化方案" class="headerlink" title="1.1 穿透优化方案"></a>1.1 穿透优化方案</h4><ol><li><p>缓存空对象+设置过期时间</p></li><li><p>缓存层之前加一个布隆过滤器（判断一定不存在，就不到缓存层去找了）<br>适用场景：数据命中不高、数据相对稳定、实时性低（通常数据集较大）的应用场景。</p></li></ol><h4 id="1-2-对比"><a href="#1-2-对比" class="headerlink" title="1.2 对比"></a>1.2 对比</h4><table><thead><tr><th>方案</th><th>适用场景</th><th>维护成本</th></tr></thead><tbody><tr><td>缓存空对象</td><td>数据命中不高、数据频繁变化</td><td>代码维护简单、需要更多缓存空间、数据源不一致</td></tr><tr><td>布隆过滤器</td><td>数据命中不高、数据相对固定、实时性低</td><td>代码维护复杂、缓存空间占用少</td></tr><tr><td><a id="more"></a></td><td></td><td></td></tr></tbody></table><hr><h3 id="2-无底洞"><a href="#2-无底洞" class="headerlink" title="2. 无底洞"></a>2. 无底洞</h3><p>现象解释：水平增加节点，性能不升，反而可能出现下降的情况。<br>可能原因分析：</p><ul><li>一次批量操作会涉及多次网络操作，随着节点增加，耗时增大</li><li>网络连接数变多，对节点性能存在一定的影响</li></ul><h4 id="2-1-无底洞优化思路"><a href="#2-1-无底洞优化思路" class="headerlink" title="2.1 无底洞优化思路"></a>2.1 无底洞优化思路</h4><ul><li>命令本身的优化，例如优化SQL</li><li>减少通信次数</li><li>降低接入成本，例如客户端使用长连接/连接池,NIO等</li></ul><h4 id="2-2-方案"><a href="#2-2-方案" class="headerlink" title="2.2 方案"></a>2.2 方案</h4><ul><li><p>串型io–单线程批量获取<br>问题：node 多，速度慢</p></li><li><p>并行io–多线程批量获取<br>问题：编程复杂，出问题，定位困难</p></li><li><p>hash_tag–让key集中在一台机器上<br>问题：业务维护成本高，可能导致数据倾斜</p></li></ul><hr><h3 id="3-缓存雪崩"><a href="#3-缓存雪崩" class="headerlink" title="3. 缓存雪崩"></a>3. 缓存雪崩</h3><p>现象解释：缓存层存在故障，导致所有请求直接请求数据存储层，从而导致存储层调用暴增，造成存储层也会级联宕机。</p><h4 id="3-1-优化思路（预防和解决）"><a href="#3-1-优化思路（预防和解决）" class="headerlink" title="3.1 优化思路（预防和解决）"></a>3.1 优化思路（预防和解决）</h4><ul><li><p>保证缓存层高可用</p></li><li><p>后端提供限流并降级实现</p></li><li><p>提前演练（预防+测试）</p></li></ul><hr><h3 id="4-热点key重建"><a href="#4-热点key重建" class="headerlink" title="4.热点key重建"></a>4.热点key重建</h3><p>现象解释：当前key是一个热点key，并发量非常大；同时，重建缓存不能在短时间内完成。因此，在缓存失效的瞬间，会有大量的线程开始重建缓存，导致后端负载过大。</p><h4 id="4-1-优化思路"><a href="#4-1-优化思路" class="headerlink" title="4.1 优化思路"></a>4.1 优化思路</h4><ul><li>减少重建缓存次数</li><li>数据尽可能一致</li><li>较少的潜在风险</li></ul><h4 id="4-2-优化方案"><a href="#4-2-优化方案" class="headerlink" title="4.2 优化方案"></a>4.2 优化方案</h4><ol><li><p>互斥锁<br>只允许一个线程重建缓存 —&gt; redis 中<code>setnx</code>命令</p></li><li><p>永远不过期<br>设置一个逻辑过期时间，和value一起存储，当发现key逻辑过期时间小于当前时间时，异步更新key（通过setnx 分布式锁，获取锁，就去异步更新），会出现数据不一致现象</p></li></ol><p>参考资料《Redis 开发与运维》</p></div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">zhangj</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://zjcool.github.io/2019/10/22/redis缓存/">https://zjcool.github.io/2019/10/22/redis缓存/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/10/22/【redis命令介绍】-client/"><i class="fa fa-chevron-left"></i><span>【redis命令介绍】- client list</span></a></div><div class="next-post pull-right"><a href="/2019/10/12/【java】-调整jvm思路/"><span>【JVM】- 调整Jvm参数SurvivorRatio思路</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2020 By zhangj</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="footer_custom_text">不学习的一天，是快乐且满足的一天！</div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script src="/js/search/local-search.js"></script><script>/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)&&($("#nav").addClass("is-mobile"),$("footer").addClass("is-mobile"))</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html><!-- rebuild by neat -->